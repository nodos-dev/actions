# Copyright MediaZ Teknoloji A.S. All Rights Reserved.
# This file is automatically synced from the nodos-dev/actions repository
# DO NOT edit this file directly in the plugin repository

name: Build

on:
  push:
    branches: [ nodos-1.2 ]
  workflow_dispatch:
    inputs:
      publish_mode:
        description: 'Publish Mode'
        required: true
        default: 'If Changed'
        type: choice
        options:
          - If Changed
          - Force
          - None
      plugin_names:
        description: 'Publish only these plugins (semicolon-delimited) (optional)'
        required: false
        default: ''
        type: string
      run_tests:
        description: 'Run Tests'
        required: false
        default: false
        type: boolean
      clean:
        description: 'Clean build'
        required: false
        default: false
        type: boolean
      sign_binaries:
        description: 'Sign binaries'
        required: false
        default: false
        type: boolean
      linux:
        description: 'Release for Linux'
        required: false
        default: true
        type: boolean
      windows:
        description: 'Release for Windows'
        required: false
        default: true
        type: boolean
      version_check:
        description: 'Version Check'
        required: true
        default: 'strict'
        type: choice
        options:
          - none
          - loose
          - strict

run-name: >-
  ${{ ((github.event_name == 'push') && format('Build Only: {0}', github.event.head_commit.message)) ||
      (github.event.inputs.publish_mode == 'If Changed') && 'Build & Release' || 
      (github.event.inputs.publish_mode == 'Force') && 'Build & Release (Force)' ||
      'Build Only' }}

concurrency:
  group: single
  cancel-in-progress: false

jobs:
  call-release-plugins:
    name: Build
    uses: nodos-dev/actions/.github/workflows/plugins.yml@main
    secrets:
      CI_TOKEN: ${{ secrets.CI_TOKEN }}
      SENTRY_TOKEN: ${{ secrets.SENTRY_TOKEN }}
    with:
      ref_name: ${{ github.ref_name }}
      publish_mode: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.publish_mode || 'None' }}
      plugin_names: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.plugin_names || '' }}
      clean: ${{ github.event_name == 'workflow_dispatch' && fromJson(github.event.inputs.clean) || false }}
      build_number: ${{ github.run_number + __BUILD_NUMBER_OFFSET__ }}
      sign_binaries: ${{github.event_name == 'workflow_dispatch' && fromJson(github.event.inputs.sign_binaries) || false }}
      linux: ${{ __LINUX_ENABLED__ && (github.event_name == 'workflow_dispatch' && fromJson(github.event.inputs.linux) || github.event_name == 'push') }}
      windows: ${{ __WINDOWS_ENABLED__ && (github.event_name == 'workflow_dispatch' && fromJson(github.event.inputs.windows) || github.event_name == 'push') }}
      run_tests: ${{ github.event_name == 'workflow_dispatch' && fromJson(github.event.inputs.run_tests) || false }}
      version_check: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version_check || 'strict' }}
