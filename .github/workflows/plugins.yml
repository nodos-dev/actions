# Copyright MediaZ Teknoloji A.S. All Rights Reserved.

name: Nodos Plugins

on:
  workflow_call:
    secrets:
      CI_TOKEN:
        required: true
      SENTRY_TOKEN:
        required: false
        description: 'If provided, PDBs will be uploaded to Sentry'
    inputs:
      ref_name:
        required: true
        type: string
      publish_mode:
        type: string
        description: 'Publish Mode. Options: If Changed, Force, None'
        default: 'If Changed'
      plugin_name:
        description: 'Publish only this plugin (single release). Leave empty to publish normally.'
        required: false
        default: ''
        type: string
      nodos_version:
        description: 'Legacy Nodos version (nosman get --version)'
        required: false
        default: ''
        type: string
      clean:
        description: 'Clean build'
        required: false
        default: false
        type: boolean
      build_number:
        description: 'Build number'
        required: false
        default: '0'
        type: string
      sign_binaries:
        description: 'Sign binaries'
        required: false
        default: false
        type: boolean
      release_notes:
        description: 'Release notes'
        required: false
        default: ''
        type: string
      pre_config_command:
        description: 'Execute a command before configuration steps'
        required: false
        default: ''
        type: string
      linux:
        description: 'Release for Linux'
        required: false
        default: true
        type: boolean
      windows:
        description: 'Release for Windows'
        required: false
        default: true
        type: boolean
      run_tests:
        description: 'Run tests'
        required: false
        default: false
        type: boolean

jobs:
  prepare-strategy:
    name: Prepare Strategy
    runs-on: self-hosted
    outputs:
      runner-list: ${{ steps.prepare-step.outputs.runner-list }}
    steps:
      - name: Prepare Runner List
        id: prepare-step
        shell: bash
        run: |
          runner_list=$(python3 -c "$(wget -q -O - https://raw.githubusercontent.com/nodos-dev/actions/refs/heads/main/scripts/prep_runner_list.py)" \
            --workflow-input-linux ${{ inputs.linux }} \
            --workflow-input-windows ${{ inputs.windows }} \
            --sign ${{ inputs.sign_binaries }} \
            --ref-name ${{ inputs.ref_name }} \
            --event-name "workflow_call")
          echo Runners: $runner_list
          echo "runner-list=$runner_list" >> $GITHUB_OUTPUT

  build:
    strategy:
      matrix:
        runner: ${{ fromJson(needs.prepare-strategy.outputs.runner-list) }}
      fail-fast: false
    name: "${{ inputs.ref_name }} - ${{ inputs.build_number }} (${{ matrix.runner[0] }}) ${{ (inputs.publish_mode != 'None' && ' (Publishing)') || '' }} ${{ (inputs.publish_mode == 'None' && ' (Build Only)') || '' }}"
    needs: prepare-strategy
    runs-on: ${{ matrix.runner }}

    env:
      GH_USERNAME: "nodos-bot"
      GIT_EMAIL: "bot@nodos.dev"
      GH_TOKEN: ${{ secrets.CI_TOKEN }}
      RUST_BACKTRACE: 1

    steps:
      - name: Setup Environment Variables
        run: |
          if [ "${{ matrix.runner[0] }}" == "Linux" ]; then
            echo "SYSTEM_NOSMAN_PATH=~/Tools/nodos/nodos" >> $GITHUB_ENV
            echo "NOSMAN_EXECUTABLE_NAME=nodos" >> $GITHUB_ENV
          else
            echo "SYSTEM_NOSMAN_PATH=C:/Tools/nodos.exe" >> $GITHUB_ENV
            echo "NOSMAN_EXECUTABLE_NAME=nodos.exe" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Update Git Credentials
        continue-on-error: true
        shell: bash
        run: |
          git credential-manager github login --username ${{ env.GH_USERNAME }} --token ${{ secrets.CI_TOKEN }} --force

      - name: Clean Build
        shell: pwsh
        if: ${{ inputs.clean }}
        run: |
          if (Test-Path -Path ./plugins-${{ inputs.ref_name }}) { Remove-Item -Path ./plugins-${{ inputs.ref_name }} -Recurse -Force }

      - name: Setup Work Folder
        shell: pwsh
        run: |
          if (-not (Test-Path -Path ./plugins-${{ inputs.ref_name }})) { New-Item -Path ./plugins-${{ inputs.ref_name }} -ItemType Directory -Force }

      - name: Ensure Nosman
        run: |
          $ErrorActionPreference = 'Stop'
          $nosmanPath = "${{ env.SYSTEM_NOSMAN_PATH }}"
          $nosmanDir = Split-Path -Parent $nosmanPath
          if (-not (Test-Path -Path $nosmanDir)) { New-Item -Path $nosmanDir -ItemType Directory -Force | Out-Null }

          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/nodos-dev/workspace/releases/latest" -Headers @{ "User-Agent" = "nodos-ci" }
          if (-not $release.tag_name) { throw "Latest release tag not found." }
          $latestVersion = $release.tag_name
          if ($latestVersion -match "(\d+\.\d+\.\d+)") { $latestVersion = $Matches[1] }

          $currentVersion = $null
          if (Test-Path -Path $nosmanPath) {
            $versionOutput = & $nosmanPath --version 2>$null
            if ($versionOutput -match "(\d+\.\d+\.\d+)") { $currentVersion = $Matches[1] }
          }

          function Compare-SemVer([string]$a, [string]$b) {
            $aParts = $a.Split('.')
            $bParts = $b.Split('.')
            for ($i = 0; $i -lt 3; $i++) {
              $aVal = [int]($aParts[$i] ?? 0)
              $bVal = [int]($bParts[$i] ?? 0)
              if ($aVal -lt $bVal) { return -1 }
              if ($aVal -gt $bVal) { return 1 }
            }
            return 0
          }

          $needsUpdate = $true
          if ($currentVersion) {
            if ((Compare-SemVer $currentVersion $latestVersion) -ge 0) { $needsUpdate = $false }
          }

          if (-not $needsUpdate) {
            Write-Host "nosman is up to date ($currentVersion)."
            exit 0
          }

          $arch = [System.Runtime.InteropServices.RuntimeInformation]::ProcessArchitecture
          $archToken = switch ($arch) {
            ([System.Runtime.InteropServices.Architecture]::X64)   { "x86_64" }
            ([System.Runtime.InteropServices.Architecture]::Arm64) { "aarch64" }
            default { "" }
          }
          if ([string]::IsNullOrEmpty($archToken)) {
            throw "Unsupported architecture for nosman download: $arch"
          }

          $osToken = if ($IsWindows) { "windows" } else { "linux" }
          $assetName = "nosman-$osToken-$archToken"
          if ($IsWindows) { $assetName = "$assetName.exe" }
          $asset = $release.assets | Where-Object { $_.name -eq $assetName } | Select-Object -First 1
          if (-not $asset) {
            $available = ($release.assets | ForEach-Object { $_.name }) -join ", "
            throw "Asset $assetName not found in latest release. Available assets: $available"
          }
          Write-Host "Downloading $($asset.browser_download_url)"
          Invoke-WebRequest -Uri $asset.browser_download_url -OutFile $nosmanPath
          if (-not $IsWindows) { chmod +x $nosmanPath }
        shell: pwsh
        working-directory: plugins-${{ inputs.ref_name }}

      - name: Setup Nodos Workspace
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not (Test-Path -Path ./workspace)) { New-Item -Path ./workspace -ItemType Directory -Force | Out-Null }
          $nosmanDestination = if ($IsWindows) { "nodos.exe" } else { "nodos" }
          $nosmanDestinationPath = Join-Path ./workspace $nosmanDestination
          Copy-Item -Path "${{ env.SYSTEM_NOSMAN_PATH }}" -Destination $nosmanDestinationPath -Force
          if (-not $IsWindows) { & chmod +x $nosmanDestinationPath }
          Push-Location ./workspace
          & ${{ env.SYSTEM_NOSMAN_PATH }} init --reinit
          & ${{ env.SYSTEM_NOSMAN_PATH }} dev init --toolchain cmake
          if (-not (Test-Path -Path ./Module)) { New-Item -Path ./Module -ItemType Directory -Force | Out-Null }
          Pop-Location
        shell: pwsh
        working-directory: plugins-${{ inputs.ref_name }}

      - name: Setup Legacy Nodos Version
        if: ${{ inputs.nodos_version != '' }}
        run: |
          Push-Location ./workspace
          ./${{ env.NOSMAN_EXECUTABLE_NAME }} get --version "${{ inputs.nodos_version }}"
          Pop-Location
        shell: pwsh
        working-directory: plugins-${{ inputs.ref_name }}

      - name: Checkout
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not (Test-Path -Path ./plugins-repo)) {
            git clone --branch ${{ inputs.ref_name }} --depth 1 https://github.com/${{ github.repository }}.git --recurse-submodule --shallow-submodules ./plugins-repo
          }
          cd ./plugins-repo
          git fetch origin
          git fetch --tags
          git clean -ffd
          git checkout ${{ github.sha }}
          git reset --hard
          git submodule update --force --recursive --init
          git status
        working-directory: plugins-${{ inputs.ref_name }}/workspace/Module

      - name: Setup Git
        run: |
          git config user.email "${{ env.GIT_EMAIL }}"
          git config user.name "${{ env.GH_USERNAME }}"
        working-directory: plugins-${{ inputs.ref_name }}/workspace/Module/plugins-repo
  
      - name: Update Nosman Cache
        shell: pwsh
        run: |
          ./${{ env.NOSMAN_EXECUTABLE_NAME }} rescan --fetch-index
        working-directory: plugins-${{ inputs.ref_name }}/workspace

      - name: Resolve Single Plugin Directory
        if: ${{ inputs.plugin_name != '' }}
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $workspaceRoot = (Resolve-Path .).Path
          $pkgName = "${{ inputs.plugin_name }}"
          $listOutput = & ./${{ env.NOSMAN_EXECUTABLE_NAME }} list --local --package-name "$pkgName"
          $cleanLines = $listOutput | ForEach-Object { $_ -replace "\x1B\[[0-9;]*[A-Za-z]", "" }
          $entries = @()
          foreach ($line in $cleanLines) {
            if ($line -match '^\s*(\d+\.\d+\.\d+(?:[-+.\w]*)?)\s+\((.+)\)\s*$') {
              $entries += [pscustomobject]@{ Version = $Matches[1]; Path = $Matches[2] }
            }
          }
          if ($entries.Count -eq 0) { throw "No local package found for $pkgName" }
          $version = $entries[-1].Version
          $infoJson = & ./${{ env.NOSMAN_EXECUTABLE_NAME }} info "$pkgName" "$version"
          $info = $infoJson | Out-String | ConvertFrom-Json
          if (-not $info.manifest_path) { throw "manifest_path not found for $pkgName $version" }
          $moduleDir = Split-Path -Parent $info.manifest_path
          $relativeModuleDir = [System.IO.Path]::GetRelativePath($workspaceRoot, $moduleDir)
          $relativeModuleDir = $relativeModuleDir -replace '\\', '/'
          "MODULE_DIRS=$relativeModuleDir" >> $env:GITHUB_ENV
        working-directory: plugins-${{ inputs.ref_name }}/workspace

      - name: Pre-Configure
        shell: pwsh
        run: |
          ${{inputs.pre_config_command}}
        working-directory: plugins-${{ inputs.ref_name }}/workspace/Module/plugins-repo

      - name: Configure
        shell: pwsh
        run: |
          $cmakeArgs = @("-S", "./Toolchain/CMake", "-B", "../Project", "-DCMAKE_BUILD_TYPE=Release")
          if ("${{ inputs.plugin_name }}" -ne "") {
            if ([string]::IsNullOrEmpty($env:MODULE_DIRS)) { throw "MODULE_DIRS is not set for single plugin build." }
            $cmakeArgs += "-DMODULE_DIRS=$env:MODULE_DIRS"
          }
          cmake @cmakeArgs
        working-directory: plugins-${{ inputs.ref_name }}/workspace

      - name: Build
        shell: pwsh
        run: |
          cmake --build ../Project --config Release -j 8
        working-directory: plugins-${{ inputs.ref_name }}/workspace

      - name: Regression Tests
        shell: pwsh
        if: ${{ inputs.run_tests }}
        run: |
          $ErrorActionPreference = 'Stop'
          
          # Windows-specific firewall setup
          if ("${{ matrix.runner[0] }}" -eq "Windows") {
            $ExePath = (Get-ChildItem -Path ./Engine -Filter "nosLauncher.exe" -Recurse | Select-Object -First 1).FullName
            if ($ExePath) {
              # Remove existing rules if they exist
              Remove-NetFirewallRule -DisplayName "CI Allow Nodos Inbound" -ErrorAction SilentlyContinue
              Remove-NetFirewallRule -DisplayName "CI Allow Nodos Outbound" -ErrorAction SilentlyContinue
              
              # Create new firewall rules
              New-NetFirewallRule -DisplayName "CI Allow Nodos Inbound" -Direction Inbound -Program $ExePath -Action Allow -Profile Any -Enabled True
              New-NetFirewallRule -DisplayName "CI Allow Nodos Outbound" -Direction Outbound -Program $ExePath -Action Allow -Profile Any -Enabled True
              Write-Host "Firewall rules created for: $ExePath"
            } else {
              Write-Host "Warning: nosLauncher.exe not found in Engine directory"
            }
          }
          
          # Run tests
          Write-Host "Running regression tests..."
          ./nodos test
          
          # Cleanup firewall rules on Windows
          if ("${{ matrix.runner[0] }}" -eq "Windows") {
            Remove-NetFirewallRule -DisplayName "CI Allow Nodos Inbound" -ErrorAction SilentlyContinue
            Remove-NetFirewallRule -DisplayName "CI Allow Nodos Outbound" -ErrorAction SilentlyContinue
            Write-Host "Firewall rules cleaned up"
          }
        working-directory: plugins-${{ inputs.ref_name }}/workspace

      - name: Sign Binaries
        if: ${{ inputs.publish_mode != 'None' && inputs.sign_binaries }}
        run: |
          cd $MEDIAZ_SCRIPTS_DIR
          python sign_module.py "${{ github.workspace }}/plugins-${{ inputs.ref_name }}/workspace/Module/plugins-repo"
        shell: bash

      - name: Upload PDBs
        if: ${{ inputs.publish_mode != 'None' && matrix.runner[0] == 'Windows'}}
        shell: pwsh
        run: |
          if ([string]::IsNullOrEmpty("${{ secrets.SENTRY_TOKEN }}")) {
            echo "SENTRY_TOKEN is not provided. Skipping PDB upload."
          } else {
            sentry-cli login --auth-token="${{ secrets.SENTRY_TOKEN }}"
            Get-ChildItem -Path . -Recurse -Filter "*.pdb" | ForEach-Object {
              sentry-cli debug-files upload -o mediaz-teknoloji -p nodos $_.FullName
            }
          }
        working-directory: plugins-${{ inputs.ref_name }}/

      - name: Publish (If Changed)
        if: ${{ inputs.publish_mode == 'If Changed' }}
        shell: bash
        run: |
          if [ "${{ inputs.sign_binaries }}" == "true" ]; then
            release_notes="${{ inputs.release_notes }}
            Signed Release"
          else
            release_notes="${{ inputs.release_notes }}
            Unsigned Release"
          fi

          packages_args=()
          if [ -n "${{ inputs.plugin_name }}" ]; then
            packages_args+=(--packages "${{ inputs.plugin_name }}")
          fi

          ../../${{ env.NOSMAN_EXECUTABLE_NAME }} \
            --workspace ../../ \
            publish-batch \
            --directory . \
            "${packages_args[@]}" \
            --vendor Nodos \
            --version-suffix ".b${{ inputs.build_number }}" \
            --verbose \
            --publisher-name "${{ env.GH_USERNAME }}" \
            --publisher-email "${{ env.GIT_EMAIL }}" \
            --tag "${{ inputs.ref_name }}" \
            --release-notes "$release_notes" \
        working-directory: plugins-${{ inputs.ref_name }}/workspace/Module/plugins-repo

      - name: Publish (Force)
        if: ${{ inputs.publish_mode == 'Force' }}
        shell: bash
        run: |
          if [ "${{ inputs.sign_binaries }}" == "true" ]; then
            release_notes="${{ inputs.release_notes }}
            Signed Release"
          else
            release_notes="${{ inputs.release_notes }}
            Unsigned Release"
          fi

          packages_args=()
          if [ -n "${{ inputs.plugin_name }}" ]; then
            packages_args+=(--packages "${{ inputs.plugin_name }}")
          fi

          ../../${{ env.NOSMAN_EXECUTABLE_NAME }} \
            --workspace ../../ \
            publish-batch \
            --directory . \
            "${packages_args[@]}" \
            --vendor=Nodos \
            --version-suffix ".b${{ inputs.build_number }}" \
            --verbose \
            --publisher-name "${{ env.GH_USERNAME }}" \
            --publisher-email "${{ env.GIT_EMAIL }}" \
            --tag "${{ inputs.ref_name }}" \
            --release-notes "$release_notes" \
            --publish-all
        working-directory: plugins-${{ inputs.ref_name }}/workspace/Module/plugins-repo
      
